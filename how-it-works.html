<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>How Bible AI Hub Works | Prompt and API Transparency</title>
  <meta name="description" content="Transparent view of every Bible AI Hub app flow: API calls, live prompts, and how outputs power final results." />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="author" content="Bible AI Hub" />
  <meta name="theme-color" content="#0f5f9b" />
  <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet" />
  <script src="/assets/sw-cleanup.js"></script>
  <link rel="stylesheet" href="/assets/styles.css" />
  <style>
    .how-wrap { max-width: 1120px; margin: 0 auto; }
    .how-hero {
      background:
        radial-gradient(120% 110% at 0% 0%, rgba(255, 255, 255, 0.22) 0%, rgba(255, 255, 255, 0) 56%),
        linear-gradient(110deg, #2f9ed2, #2b67c7);
      color: #fff;
      text-align: center;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.24);
      padding: 1.05rem 1.15rem;
      margin-bottom: 0.85rem;
    }
    .how-hero h1 { margin: 0; font-size: clamp(1.22rem, 2.3vw, 1.7rem); font-family: "Space Grotesk", "Segoe UI", sans-serif; }
    .how-hero p { margin: 0.45rem auto 0; max-width: 900px; color: #e8f2ff; }
    .how-grid { display: grid; gap: 0.85rem; }
    .how-map { border: 1px solid #d7e5f2; border-radius: 14px; background: #fff; box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06); overflow: hidden; }
    .how-head {
      padding: 0.78rem 0.88rem;
      border-bottom: 1px solid #dce8f3;
      background: linear-gradient(90deg, #f5fbff, #f7f9ff);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }
    .how-head h2 { margin: 0; color: #1f425f; font-size: 1rem; }
    .how-endpoint {
      border-radius: 999px;
      border: 1px solid #cbe1f1;
      background: #edf6ff;
      color: #2a557d;
      font-size: 0.77rem;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      font-weight: 700;
      padding: 0.24rem 0.62rem;
      white-space: nowrap;
    }
    .how-body {
      padding: 0.85rem;
      display: grid;
      gap: 0.85rem;
    }
    .how-flow {
      border: 1px solid #dce8f4;
      border-radius: 12px;
      background: #fbfeff;
      padding: 0.62rem;
      overflow-x: auto;
    }
    .how-flow-row {
      display: flex;
      align-items: stretch;
      gap: 0.5rem;
      min-width: min(100%, 920px);
    }
    .how-node {
      min-width: 196px;
      border: 1px solid #d5e4f1;
      border-radius: 11px;
      background: #fff;
      padding: 0.5rem 0.55rem;
    }
    .how-node-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.35rem;
      margin-bottom: 0.2rem;
    }
    .how-step-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: 1px solid #bfd6ea;
      background: #f0f7ff;
      color: #24517a;
      font-size: 0.68rem;
      font-weight: 700;
      line-height: 1;
      padding: 0.14rem 0.46rem;
      white-space: nowrap;
    }
    .how-node p { margin: 0.12rem 0 0; color: #4f6b85; font-size: 0.79rem; line-height: 1.3; }
    .how-node .k {
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 0.66rem;
      color: #617b95;
      font-weight: 700;
    }
    .how-node .v {
      margin: 0.06rem 0 0;
      color: #1f415f;
      font-size: 0.85rem;
      font-weight: 700;
      line-height: 1.24;
    }
    .how-node.prompt { border-color: #c7ddf0; background: linear-gradient(180deg, #f5fbff, #fff); }
    .how-node.ai { border-color: #c9e4d7; background: linear-gradient(180deg, #f5fff9, #fff); }
    .how-node.data { border-color: #e1d9c6; background: linear-gradient(180deg, #fffbf3, #fff); }
    .how-sections {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 0.72rem;
    }
    .how-lite {
      border: 1px solid #dbe8f3;
      border-radius: 12px;
      background: #f9fcff;
      padding: 0.62rem 0.68rem;
    }
    .how-lite h3 {
      margin: 0;
      color: #244a6b;
      font-size: 0.9rem;
    }
    .how-lite ul {
      margin: 0.44rem 0 0;
      padding-left: 1.06rem;
      color: #4f6a84;
      font-size: 0.82rem;
      line-height: 1.34;
    }
    .how-prompt {
      border: 1px solid #d7e5f2;
      border-radius: 11px;
      background: #fff;
      padding: 0.56rem 0.62rem;
    }
    .how-prompt + .how-prompt { margin-top: 0.58rem; }
    .how-prompt h4 {
      margin: 0;
      color: #1f415f;
      font-size: 0.86rem;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
    }
    .how-prompt .inline-hint { margin-top: 0.18rem; }
    .how-pre {
      margin-top: 0.4rem;
      border: 1px solid #d7e5f2;
      border-radius: 10px;
      background: #f8fbff;
      color: #1f415f;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 0.74rem;
      line-height: 1.36;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      padding: 0.56rem 0.6rem;
      max-height: 360px;
      overflow: auto;
    }
    .how-details + .how-details { margin-top: 0.44rem; }
    .how-details summary {
      list-style: none;
      cursor: pointer;
      font-weight: 700;
      color: #244a6b;
    }
    .how-details summary::marker,
    .how-details summary::-webkit-details-marker {
      display: none;
      content: "";
    }
    .how-editor {
      margin-top: 0.45rem;
      padding: 0.58rem;
      border: 1px solid #dce8f3;
      border-radius: 10px;
      background: linear-gradient(180deg, #f9fcff, #fff);
    }
    .how-editor h5 {
      margin: 0 0 0.4rem;
      color: #1f415f;
      font-size: 0.79rem;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
    }
    .how-editor-grid {
      display: grid;
      gap: 0.42rem;
    }
    .how-editor-label {
      color: #456483;
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .how-editor textarea {
      width: 100%;
      min-height: 140px;
      border-radius: 10px;
      border: 1px solid #cfe1f0;
      background: #fff;
      color: #1f415f;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 0.74rem;
      line-height: 1.35;
      padding: 0.5rem;
      resize: vertical;
    }
    .how-editor-actions {
      display: flex;
      align-items: center;
      gap: 0.45rem;
      margin-top: 0.45rem;
      flex-wrap: wrap;
    }
    .how-btn {
      border: 1px solid #c8daeb;
      border-radius: 10px;
      background: #fff;
      color: #24547f;
      font-size: 0.76rem;
      font-weight: 700;
      padding: 0.34rem 0.6rem;
      cursor: pointer;
    }
    .how-btn:hover { background: #f1f7ff; }
    .how-btn:disabled {
      opacity: 0.58;
      cursor: wait;
    }
    .how-btn.primary {
      border-color: #7ab0d9;
      background: linear-gradient(180deg, #2f9ed2, #2b67c7);
      color: #fff;
    }
    .how-tree {
      margin-top: 0.4rem;
      border: 1px solid #d7e5f2;
      border-radius: 10px;
      background:
        linear-gradient(180deg, #f8fbff, #fff),
        repeating-linear-gradient(0deg, rgba(174, 200, 224, 0.12), rgba(174, 200, 224, 0.12) 1px, transparent 1px, transparent 22px);
      padding: 0.58rem;
      max-height: 360px;
      overflow: auto;
      font-size: 0.77rem;
    }
    .how-tree-list,
    .how-tree-list ul {
      list-style: none;
      margin: 0;
      padding-left: 0.95rem;
      position: relative;
    }
    .how-tree-list ul::before {
      content: "";
      position: absolute;
      left: 0.36rem;
      top: 0;
      bottom: 0.15rem;
      border-left: 1px dashed #bfd5e8;
    }
    .how-tree-node {
      position: relative;
      margin: 0.16rem 0;
    }
    .how-tree-node::before {
      content: "";
      position: absolute;
      left: -0.6rem;
      top: 0.7rem;
      width: 0.56rem;
      border-top: 1px dashed #bfd5e8;
    }
    .how-tree-row {
      display: inline-flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.28rem;
      border: 1px solid #d2e2ef;
      border-radius: 8px;
      background: #fff;
      padding: 0.2rem 0.42rem;
      min-height: 1.5rem;
    }
    .how-tree-key {
      color: #1f415f;
      font-weight: 700;
    }
    .how-tree-type {
      border-radius: 999px;
      border: 1px solid #d2deea;
      background: #f4f8fd;
      color: #527192;
      font-size: 0.66rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      padding: 0.04rem 0.35rem;
    }
    .how-tree-value {
      color: #355979;
      overflow-wrap: anywhere;
    }
    .how-note {
      margin-top: 0.7rem;
      border: 1px solid #dce8f3;
      border-radius: 12px;
      background: #f7fbff;
      padding: 0.62rem 0.7rem;
      color: #4a6580;
      font-size: 0.82rem;
      line-height: 1.33;
    }
    @media (min-width: 920px) {
      .how-sections {
        grid-template-columns: 1.4fr 1fr;
      }
    }
    @media (max-width: 760px) {
      .how-head {
        flex-direction: column;
        align-items: flex-start;
      }
      .how-flow-row {
        min-width: 100%;
      }
      .how-node {
        min-width: 170px;
      }
    }
  </style>
</head>
<body>
  <div class="site-wrap">
    <header class="site-header">
      <div class="header-inner">
        <a class="brand" href="/">Bible AI Hub</a>
      </div>
    </header>

    <main class="main">
      <div class="how-wrap">
        <section class="how-hero">
          <h1>How Bible AI Hub Works</h1>
          <p>This page is generated from the live API map. For each app, you can see the complete prompts, a sample response tree, and how each response is used in final output.</p>
        </section>
        <div id="howMount" class="how-grid">
          <div class="card">
            <p class="inline-hint">Loading prompt and flow map...</p>
          </div>
        </div>
      </div>
    </main>

    <footer class="micro-footer">
      <p>Made with &#10084;&#65039; | <a href="https://hiredalmo.com" target="_blank" rel="noopener noreferrer">hiredalmo.com</a></p>
    </footer>
  </div>

  <script src="/assets/shared.js"></script>
  <script>
    (function () {
      const mount = document.getElementById("howMount");
      const {
        apiGet,
        apiPatch,
        ensureAuthReady,
        cleanString,
        escapeHtml
      } = window.AIBible || {};
      if (!mount || !apiGet || !apiPatch || !ensureAuthReady) {
        return;
      }
      let canEditPrompts = false;

      function promptRoleLabel(type) {
        const key = cleanString(type).toLowerCase();
        if (key === "prompt") return "Prompt";
        if (key === "audio") return "Audio";
        if (key === "embedding") return "Embedding";
        if (key === "passage") return "Passage";
        return "Call";
      }

      function nodeClassForCall(type) {
        const key = cleanString(type).toLowerCase();
        if (key === "prompt") return "how-node prompt";
        if (key === "audio" || key === "embedding") return "how-node ai";
        if (key === "passage") return "how-node data";
        return "how-node";
      }

      function renderLeafValue(value) {
        if (typeof value === "string") return `"${value}"`;
        if (typeof value === "number" || typeof value === "boolean") return String(value);
        if (value === null) return "null";
        return cleanString(value);
      }

      function nodeTypeLabel(value) {
        if (Array.isArray(value)) return "array";
        if (value === null) return "null";
        return typeof value;
      }

      function renderTreeNode(key, value) {
        const keyLabel = escapeHtml(cleanString(key, "item"));
        if (Array.isArray(value)) {
          const childNodes = value.length
            ? `<ul>${value.map((item, index) => renderTreeNode(`[${index}]`, item)).join("")}</ul>`
            : "";
          return `
            <li class="how-tree-node">
              <div class="how-tree-row">
                <span class="how-tree-key">${keyLabel}</span>
                <span class="how-tree-type">array</span>
                ${value.length ? `<span class="how-tree-value">${value.length} item${value.length === 1 ? "" : "s"}</span>` : `<span class="how-tree-value">empty</span>`}
              </div>
              ${childNodes}
            </li>
          `;
        }
        if (value && typeof value === "object") {
          const entries = Object.entries(value);
          const childNodes = entries.length
            ? `<ul>${entries.map(([childKey, childValue]) => renderTreeNode(childKey, childValue)).join("")}</ul>`
            : "";
          return `
            <li class="how-tree-node">
              <div class="how-tree-row">
                <span class="how-tree-key">${keyLabel}</span>
                <span class="how-tree-type">object</span>
                ${entries.length ? "" : `<span class="how-tree-value">empty</span>`}
              </div>
              ${childNodes}
            </li>
          `;
        }
        return `
          <li class="how-tree-node">
            <div class="how-tree-row">
              <span class="how-tree-key">${keyLabel}</span>
              <span class="how-tree-type">${escapeHtml(nodeTypeLabel(value))}</span>
              <span class="how-tree-value">${escapeHtml(renderLeafValue(value))}</span>
            </div>
          </li>
        `;
      }

      function renderExampleTree(example) {
        const root = example && typeof example === "object" ? example : {};
        return `
          <div class="how-tree">
            <ul class="how-tree-list">
              ${renderTreeNode("Example Response", root)}
            </ul>
          </div>
        `;
      }

      function buildOverrideLabel(prompt) {
        const override = prompt && prompt.override && typeof prompt.override === "object"
          ? prompt.override
          : {};
        const active = Boolean(override.active);
        if (!active) {
          return "Using default server prompt text.";
        }
        const by = cleanString(override.updatedByEmail);
        const at = cleanString(override.updatedAt);
        const byLine = by ? ` by ${by}` : "";
        const atLine = at ? ` on ${at}` : "";
        return `Custom prompt override is active${byLine}${atLine}.`;
      }

      function renderFlowNodes(appRow) {
        const calls = Array.isArray(appRow && appRow.calls) ? appRow.calls : [];
        const nodes = [{
          type: "data",
          title: "User Input",
          detail: "Form inputs and optional uploaded content."
        }]
        .concat(calls.map((call) => ({
          type: cleanString(call.type),
          title: cleanString(call.promptId || call.endpoint || "Pipeline call"),
          detail: cleanString(call.role)
        })))
        .concat([{
          type: "ai",
          title: "Final Output",
          detail: "Structured response rendered in the app."
        }]);

        return `
          <div class="how-flow">
            <div class="how-flow-row">
              ${nodes.map((node, index) => `
                <div class="${escapeHtml(nodeClassForCall(node.type))}">
                  <div class="how-node-head">
                    <p class="k">${escapeHtml(promptRoleLabel(node.type))}</p>
                    <span class="how-step-chip">Step ${index + 1}</span>
                  </div>
                  <p class="v">${escapeHtml(node.title)}</p>
                  <p>${escapeHtml(node.detail)}</p>
                </div>
              `).join("")}
            </div>
          </div>
        `;
      }

      function renderPromptDetails(promptCall, index) {
        const prompt = promptCall && promptCall.prompt && typeof promptCall.prompt === "object"
          ? promptCall.prompt
          : {};
        const promptId = cleanString(prompt.id || promptCall.promptId, "Prompt");
        const responseExample = prompt.responseExample && typeof prompt.responseExample === "object"
          ? prompt.responseExample
          : {};
        const systemText = cleanString(prompt.system);
        const userText = cleanString(prompt.user);
        const overrideLabel = buildOverrideLabel(prompt);

        return `
          <article class="how-prompt">
            <h4>${escapeHtml(promptId)} ${cleanString(prompt.version) ? `(${escapeHtml(cleanString(prompt.version))})` : ""}</h4>
            <p class="inline-hint">${escapeHtml(cleanString(prompt.task, cleanString(promptCall.role)))}</p>
            <p class="inline-hint">${escapeHtml(overrideLabel)}</p>

            <details class="how-details" ${index === 0 ? "open" : ""}>
              <summary>System Prompt (full text)</summary>
              <pre class="how-pre" data-preview-system>${escapeHtml(systemText || "No system prompt text available.")}</pre>
            </details>

            <details class="how-details">
              <summary>User Prompt Template (full text)</summary>
              <pre class="how-pre" data-preview-user>${escapeHtml(userText || "No user prompt template available.")}</pre>
            </details>

            <details class="how-details">
              <summary>Example Response</summary>
              ${renderExampleTree(responseExample)}
            </details>

            ${canEditPrompts
              ? `
                <section class="how-editor" data-prompt-editor data-prompt-id="${escapeHtml(promptId)}">
                  <h5>Admin Prompt Editor</h5>
                  <div class="how-editor-grid">
                    <span class="how-editor-label">System Prompt</span>
                    <textarea data-prompt-system>${escapeHtml(systemText)}</textarea>
                    <span class="how-editor-label">User Prompt Template</span>
                    <textarea data-prompt-user>${escapeHtml(userText)}</textarea>
                  </div>
                  <div class="how-editor-actions">
                    <button type="button" class="how-btn primary" data-prompt-save>Save for all users</button>
                    <button type="button" class="how-btn" data-prompt-reset>Reset to default</button>
                    <span class="inline-hint" data-prompt-status>${escapeHtml(overrideLabel)}</span>
                  </div>
                </section>
              `
              : ""
            }
          </article>
        `;
      }

      function renderApp(appRow) {
        const promptCalls = Array.isArray(appRow && appRow.promptCalls) ? appRow.promptCalls : [];
        const nonPromptCalls = (Array.isArray(appRow && appRow.calls) ? appRow.calls : [])
          .filter((call) => cleanString(call.type).toLowerCase() !== "prompt");
        const outputUsage = Array.isArray(appRow && appRow.outputUsage) ? appRow.outputUsage : [];

        return `
          <article class="how-map">
            <header class="how-head">
              <h2>${escapeHtml(cleanString(appRow.name, "App"))}</h2>
              <span class="how-endpoint">${escapeHtml(cleanString(appRow.endpoint, "API route"))}</span>
            </header>
            <div class="how-body">
              ${renderFlowNodes(appRow)}
              <div class="how-sections">
                <section class="how-lite">
                  <h3>How Outputs Are Used</h3>
                  ${outputUsage.length
                    ? `<ul>${outputUsage.map((line) => `<li>${escapeHtml(cleanString(line))}</li>`).join("")}</ul>`
                    : `<p class="inline-hint">No output-usage mapping was returned.</p>`}
                  <h3 style="margin-top:0.62rem;">Supporting Calls</h3>
                  ${nonPromptCalls.length
                    ? `<ul>${nonPromptCalls.map((call) => `<li><strong>${escapeHtml(cleanString(call.endpoint || call.promptId, cleanString(call.type)))}</strong> ${cleanString(call.optional) ? "(optional)" : ""} - ${escapeHtml(cleanString(call.role))}</li>`).join("")}</ul>`
                    : `<p class="inline-hint">This app only uses prompt calls in this map.</p>`}
                </section>
                <section class="how-lite">
                  <h3>Prompt Transparency</h3>
                  ${promptCalls.length
                    ? promptCalls.map((promptCall, index) => renderPromptDetails(promptCall, index)).join("")
                    : `<p class="inline-hint">No prompt calls found for this app.</p>`}
                </section>
              </div>
            </div>
          </article>
        `;
      }

      function setEditorStatus(statusEl, message, isError) {
        if (!statusEl) {
          return;
        }
        statusEl.textContent = cleanString(message);
        statusEl.style.color = isError ? "#8a2b2b" : "#4a6580";
      }

      function bindPromptEditors() {
        if (!canEditPrompts) {
          return;
        }
        const editors = Array.from(mount.querySelectorAll("[data-prompt-editor]"));
        editors.forEach((editor) => {
          const promptId = cleanString(editor.getAttribute("data-prompt-id"));
          const systemInput = editor.querySelector("[data-prompt-system]");
          const userInput = editor.querySelector("[data-prompt-user]");
          const saveButton = editor.querySelector("[data-prompt-save]");
          const resetButton = editor.querySelector("[data-prompt-reset]");
          const statusEl = editor.querySelector("[data-prompt-status]");
          const promptCard = editor.closest(".how-prompt");
          const systemPreview = promptCard ? promptCard.querySelector("[data-preview-system]") : null;
          const userPreview = promptCard ? promptCard.querySelector("[data-preview-user]") : null;

          if (!promptId || !systemInput || !userInput || !saveButton || !resetButton) {
            return;
          }

          async function savePrompt() {
            const system = cleanString(systemInput.value);
            const user = cleanString(userInput.value);
            if (!system || !user) {
              setEditorStatus(statusEl, "System and user prompt text are both required.", true);
              return;
            }
            saveButton.disabled = true;
            resetButton.disabled = true;
            setEditorStatus(statusEl, "Saving prompt override...", false);
            try {
              const response = await apiPatch(`/api/how-it-works/prompts/${encodeURIComponent(promptId)}`, {
                system,
                user
              });
              const updatedPrompt = response && response.prompt && typeof response.prompt === "object"
                ? response.prompt
                : {};
              const nextSystem = cleanString(updatedPrompt.system, system);
              const nextUser = cleanString(updatedPrompt.user, user);
              systemInput.value = nextSystem;
              userInput.value = nextUser;
              if (systemPreview) {
                systemPreview.textContent = nextSystem || "No system prompt text available.";
              }
              if (userPreview) {
                userPreview.textContent = nextUser || "No user prompt template available.";
              }
              setEditorStatus(statusEl, "Saved. This prompt now applies to all users.", false);
            } catch (error) {
              setEditorStatus(statusEl, cleanString(error && error.message, "Could not save prompt override."), true);
            } finally {
              saveButton.disabled = false;
              resetButton.disabled = false;
            }
          }

          async function resetPrompt() {
            saveButton.disabled = true;
            resetButton.disabled = true;
            setEditorStatus(statusEl, "Resetting to default prompt text...", false);
            try {
              const response = await apiPatch(`/api/how-it-works/prompts/${encodeURIComponent(promptId)}`, {
                resetToDefault: true
              });
              const updatedPrompt = response && response.prompt && typeof response.prompt === "object"
                ? response.prompt
                : {};
              const nextSystem = cleanString(updatedPrompt.system);
              const nextUser = cleanString(updatedPrompt.user);
              systemInput.value = nextSystem;
              userInput.value = nextUser;
              if (systemPreview) {
                systemPreview.textContent = nextSystem || "No system prompt text available.";
              }
              if (userPreview) {
                userPreview.textContent = nextUser || "No user prompt template available.";
              }
              setEditorStatus(statusEl, "Reset complete. Default prompt text is active.", false);
            } catch (error) {
              setEditorStatus(statusEl, cleanString(error && error.message, "Could not reset prompt override."), true);
            } finally {
              saveButton.disabled = false;
              resetButton.disabled = false;
            }
          }

          saveButton.addEventListener("click", () => {
            void savePrompt();
          });
          resetButton.addEventListener("click", () => {
            void resetPrompt();
          });
        });
      }

      async function loadMap() {
        try {
          await ensureAuthReady();
          const payload = await apiGet("/api/how-it-works");
          const apps = Array.isArray(payload && payload.apps) ? payload.apps : [];
          const models = payload && payload.modelDefaults && typeof payload.modelDefaults === "object"
            ? payload.modelDefaults
            : {};
          const viewer = payload && payload.viewer && typeof payload.viewer === "object"
            ? payload.viewer
            : {};
          canEditPrompts = Boolean(viewer.canEditPrompts);
          const modeLine = canEditPrompts
            ? "Admin mode is enabled. Saving edits here updates live prompts for every user."
            : "Read-only mode. Only the admin account can edit prompts from this page.";

          mount.innerHTML = `
            <article class="card">
              <h2 class="section-title">Model Defaults</h2>
              <ul class="list">
                <li><strong>Primary Chat:</strong> ${escapeHtml(cleanString(models.primaryChatModel, "n/a"))}</li>
                <li><strong>Long Form:</strong> ${escapeHtml(cleanString(models.longFormModel, "n/a"))}</li>
                <li><strong>Bible Study:</strong> ${escapeHtml(cleanString(models.bibleStudyModel, "n/a"))}</li>
                <li><strong>Embeddings:</strong> ${escapeHtml(cleanString(models.embeddingModel, "n/a"))}</li>
                <li><strong>Transcription:</strong> ${escapeHtml(cleanString(models.transcriptionModel, "n/a"))}</li>
              </ul>
              <p class="inline-hint" style="margin-top:0.5rem;">${escapeHtml(modeLine)}</p>
            </article>
            ${apps.map((appRow) => renderApp(appRow)).join("")}
            <div class="how-note">
              This page is generated from <code>/api/how-it-works</code> so live prompt text and flow maps stay aligned with current server code.
            </div>
          `;
          bindPromptEditors();
        } catch (error) {
          mount.innerHTML = `
            <article class="card">
              <h2 class="section-title">Could not load flow map</h2>
              <p class="inline-hint">${escapeHtml(cleanString(error && error.message, "API request failed."))}</p>
              <p class="inline-hint">Start the API server and ensure <code>/api/how-it-works</code> is reachable.</p>
            </article>
          `;
        }
      }

      void loadMap();
    })();
  </script>
</body>
</html>
