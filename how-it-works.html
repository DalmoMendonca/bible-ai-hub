<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>How Bible AI Hub Works | Prompt and API Transparency</title>
  <meta name="description" content="Transparent view of every Bible AI Hub app flow: API calls, full prompts, response shapes, and how outputs power final results." />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="author" content="Bible AI Hub" />
  <meta name="theme-color" content="#0f5f9b" />
  <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet" />
  <script src="/assets/sw-cleanup.js"></script>
  <link rel="stylesheet" href="/assets/styles.css" />
  <style>
    .how-wrap { max-width: 1120px; margin: 0 auto; }
    .how-hero {
      background:
        radial-gradient(120% 110% at 0% 0%, rgba(255, 255, 255, 0.22) 0%, rgba(255, 255, 255, 0) 56%),
        linear-gradient(110deg, #2f9ed2, #2b67c7);
      color: #fff;
      text-align: center;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.24);
      padding: 1.05rem 1.15rem;
      margin-bottom: 0.85rem;
    }
    .how-hero h1 { margin: 0; font-size: clamp(1.22rem, 2.3vw, 1.7rem); font-family: "Space Grotesk", "Segoe UI", sans-serif; }
    .how-hero p { margin: 0.45rem auto 0; max-width: 900px; color: #e8f2ff; }
    .how-grid { display: grid; gap: 0.85rem; }
    .how-map { border: 1px solid #d7e5f2; border-radius: 14px; background: #fff; box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06); overflow: hidden; }
    .how-head {
      padding: 0.78rem 0.88rem;
      border-bottom: 1px solid #dce8f3;
      background: linear-gradient(90deg, #f5fbff, #f7f9ff);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }
    .how-head h2 { margin: 0; color: #1f425f; font-size: 1rem; }
    .how-endpoint {
      border-radius: 999px;
      border: 1px solid #cbe1f1;
      background: #edf6ff;
      color: #2a557d;
      font-size: 0.77rem;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      font-weight: 700;
      padding: 0.24rem 0.62rem;
      white-space: nowrap;
    }
    .how-body {
      padding: 0.85rem;
      display: grid;
      gap: 0.85rem;
    }
    .how-flow {
      border: 1px solid #dce8f4;
      border-radius: 12px;
      background: #fbfeff;
      padding: 0.62rem;
      overflow-x: auto;
    }
    .how-flow-row {
      display: flex;
      align-items: stretch;
      gap: 0.46rem;
      min-width: min(100%, 840px);
    }
    .how-node {
      min-width: 180px;
      border: 1px solid #d5e4f1;
      border-radius: 11px;
      background: #fff;
      padding: 0.5rem 0.55rem;
    }
    .how-node p { margin: 0.12rem 0 0; color: #4f6b85; font-size: 0.79rem; line-height: 1.3; }
    .how-node .k {
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 0.66rem;
      color: #617b95;
      font-weight: 700;
    }
    .how-node .v {
      margin: 0.06rem 0 0;
      color: #1f415f;
      font-size: 0.85rem;
      font-weight: 700;
      line-height: 1.24;
    }
    .how-node.prompt { border-color: #c7ddf0; background: linear-gradient(180deg, #f5fbff, #fff); }
    .how-node.ai { border-color: #c9e4d7; background: linear-gradient(180deg, #f5fff9, #fff); }
    .how-node.data { border-color: #e1d9c6; background: linear-gradient(180deg, #fffbf3, #fff); }
    .how-arrow { align-self: center; color: #7c93ab; font-size: 0.98rem; font-weight: 700; }
    .how-sections {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 0.72rem;
    }
    .how-lite {
      border: 1px solid #dbe8f3;
      border-radius: 12px;
      background: #f9fcff;
      padding: 0.62rem 0.68rem;
    }
    .how-lite h3 {
      margin: 0;
      color: #244a6b;
      font-size: 0.9rem;
    }
    .how-lite ul {
      margin: 0.44rem 0 0;
      padding-left: 1.06rem;
      color: #4f6a84;
      font-size: 0.82rem;
      line-height: 1.34;
    }
    .how-prompt {
      border: 1px solid #d7e5f2;
      border-radius: 11px;
      background: #fff;
      padding: 0.56rem 0.62rem;
    }
    .how-prompt + .how-prompt { margin-top: 0.58rem; }
    .how-prompt h4 {
      margin: 0;
      color: #1f415f;
      font-size: 0.86rem;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
    }
    .how-prompt .inline-hint { margin-top: 0.18rem; }
    .how-pre {
      margin-top: 0.4rem;
      border: 1px solid #d7e5f2;
      border-radius: 10px;
      background: #f8fbff;
      color: #1f415f;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 0.74rem;
      line-height: 1.36;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      padding: 0.56rem 0.6rem;
      max-height: 360px;
      overflow: auto;
    }
    .how-details + .how-details { margin-top: 0.44rem; }
    .how-details summary {
      list-style: none;
      cursor: pointer;
      font-weight: 700;
      color: #244a6b;
    }
    .how-details summary::marker,
    .how-details summary::-webkit-details-marker {
      display: none;
      content: "";
    }
    .how-note {
      margin-top: 0.7rem;
      border: 1px solid #dce8f3;
      border-radius: 12px;
      background: #f7fbff;
      padding: 0.62rem 0.7rem;
      color: #4a6580;
      font-size: 0.82rem;
      line-height: 1.33;
    }
    @media (min-width: 920px) {
      .how-sections {
        grid-template-columns: 1.4fr 1fr;
      }
    }
    @media (max-width: 760px) {
      .how-head {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="site-wrap">
    <header class="site-header">
      <div class="header-inner">
        <a class="brand" href="/">Bible AI Hub</a>
      </div>
    </header>

    <main class="main">
      <div class="how-wrap">
        <section class="how-hero">
          <h1>How Bible AI Hub Works</h1>
          <p>This page is generated from the live API map. For each app, you can see the complete prompt text, response patterns, and how each response is used in final output.</p>
        </section>
        <div id="howMount" class="how-grid">
          <div class="card">
            <p class="inline-hint">Loading prompt and flow map...</p>
          </div>
        </div>
      </div>
    </main>

    <footer class="micro-footer">
      <p>Made with &#10084;&#65039; | <a href="https://hiredalmo.com" target="_blank" rel="noopener noreferrer">hiredalmo.com</a></p>
    </footer>
  </div>

  <script src="/assets/shared.js"></script>
  <script>
    (function () {
      const mount = document.getElementById("howMount");
      const { publicApiGet, cleanString, escapeHtml } = window.AIBible || {};
      if (!mount || !publicApiGet) {
        return;
      }

      function promptRoleLabel(type) {
        const key = cleanString(type).toLowerCase();
        if (key === "prompt") return "Prompt";
        if (key === "audio") return "Audio";
        if (key === "embedding") return "Embedding";
        if (key === "passage") return "Passage";
        return "Call";
      }

      function nodeClassForCall(type) {
        const key = cleanString(type).toLowerCase();
        if (key === "prompt") return "how-node prompt";
        if (key === "audio" || key === "embedding") return "how-node ai";
        if (key === "passage") return "how-node data";
        return "how-node";
      }

      function renderFlowNodes(appRow) {
        const calls = Array.isArray(appRow && appRow.calls) ? appRow.calls : [];
        const nodes = [{
          type: "data",
          title: "User Input",
          detail: "Form inputs and optional uploaded content."
        }]
        .concat(calls.map((call) => ({
          type: cleanString(call.type),
          title: cleanString(call.promptId || call.endpoint || "Pipeline call"),
          detail: cleanString(call.role)
        })))
        .concat([{
          type: "ai",
          title: "Final Output",
          detail: "Structured response rendered in the app."
        }]);

        return `
          <div class="how-flow">
            <div class="how-flow-row">
              ${nodes.map((node, index) => `
                <div class="${escapeHtml(nodeClassForCall(node.type))}">
                  <p class="k">${escapeHtml(promptRoleLabel(node.type))}</p>
                  <p class="v">${escapeHtml(node.title)}</p>
                  <p>${escapeHtml(node.detail)}</p>
                </div>
                ${index < nodes.length - 1 ? '<div class="how-arrow">-&gt;</div>' : ""}
              `).join("")}
            </div>
          </div>
        `;
      }

      function renderPromptDetails(promptCall, index) {
        const prompt = promptCall && promptCall.prompt && typeof promptCall.prompt === "object"
          ? promptCall.prompt
          : {};
        const responseShape = prompt.responseShape && typeof prompt.responseShape === "object"
          ? JSON.stringify(prompt.responseShape, null, 2)
          : "{}";
        const responseExample = prompt.responseExample && typeof prompt.responseExample === "object"
          ? JSON.stringify(prompt.responseExample, null, 2)
          : "{}";
        const systemText = cleanString(prompt.system);
        const userText = cleanString(prompt.user);

        return `
          <article class="how-prompt">
            <h4>${escapeHtml(cleanString(prompt.id || promptCall.promptId, "Prompt"))} ${cleanString(prompt.version) ? `(${escapeHtml(cleanString(prompt.version))})` : ""}</h4>
            <p class="inline-hint">${escapeHtml(cleanString(prompt.task, cleanString(promptCall.role)))}</p>

            <details class="how-details" ${index === 0 ? "open" : ""}>
              <summary>System Prompt (full text)</summary>
              <pre class="how-pre">${escapeHtml(systemText || "No system prompt text available.")}</pre>
            </details>

            <details class="how-details">
              <summary>User Prompt Template (full text)</summary>
              <pre class="how-pre">${escapeHtml(userText || "No user prompt template available.")}</pre>
            </details>

            <details class="how-details">
              <summary>Expected Response Shape</summary>
              <pre class="how-pre">${escapeHtml(responseShape)}</pre>
            </details>

            <details class="how-details">
              <summary>Example Response Object</summary>
              <pre class="how-pre">${escapeHtml(responseExample)}</pre>
            </details>
          </article>
        `;
      }

      function renderApp(appRow) {
        const promptCalls = Array.isArray(appRow && appRow.promptCalls) ? appRow.promptCalls : [];
        const nonPromptCalls = (Array.isArray(appRow && appRow.calls) ? appRow.calls : [])
          .filter((call) => cleanString(call.type).toLowerCase() !== "prompt");
        const outputUsage = Array.isArray(appRow && appRow.outputUsage) ? appRow.outputUsage : [];

        return `
          <article class="how-map">
            <header class="how-head">
              <h2>${escapeHtml(cleanString(appRow.name, "App"))}</h2>
              <span class="how-endpoint">${escapeHtml(cleanString(appRow.endpoint, "API route"))}</span>
            </header>
            <div class="how-body">
              ${renderFlowNodes(appRow)}
              <div class="how-sections">
                <section class="how-lite">
                  <h3>How Outputs Are Used</h3>
                  ${outputUsage.length
                    ? `<ul>${outputUsage.map((line) => `<li>${escapeHtml(cleanString(line))}</li>`).join("")}</ul>`
                    : `<p class="inline-hint">No output-usage mapping was returned.</p>`}
                  <h3 style="margin-top:0.62rem;">Supporting Calls</h3>
                  ${nonPromptCalls.length
                    ? `<ul>${nonPromptCalls.map((call) => `<li><strong>${escapeHtml(cleanString(call.endpoint || call.promptId, cleanString(call.type)))}</strong> ${cleanString(call.optional) ? "(optional)" : ""} - ${escapeHtml(cleanString(call.role))}</li>`).join("")}</ul>`
                    : `<p class="inline-hint">This app only uses prompt calls in this map.</p>`}
                </section>
                <section class="how-lite">
                  <h3>Prompt Transparency</h3>
                  ${promptCalls.length
                    ? promptCalls.map((promptCall, index) => renderPromptDetails(promptCall, index)).join("")
                    : `<p class="inline-hint">No prompt calls found for this app.</p>`}
                </section>
              </div>
            </div>
          </article>
        `;
      }

      async function loadMap() {
        try {
          const payload = await publicApiGet("/api/how-it-works");
          const apps = Array.isArray(payload && payload.apps) ? payload.apps : [];
          const models = payload && payload.modelDefaults && typeof payload.modelDefaults === "object"
            ? payload.modelDefaults
            : {};

          mount.innerHTML = `
            <article class="card">
              <h2 class="section-title">Model Defaults</h2>
              <ul class="list">
                <li><strong>Primary Chat:</strong> ${escapeHtml(cleanString(models.primaryChatModel, "n/a"))}</li>
                <li><strong>Long Form:</strong> ${escapeHtml(cleanString(models.longFormModel, "n/a"))}</li>
                <li><strong>Bible Study:</strong> ${escapeHtml(cleanString(models.bibleStudyModel, "n/a"))}</li>
                <li><strong>Embeddings:</strong> ${escapeHtml(cleanString(models.embeddingModel, "n/a"))}</li>
                <li><strong>Transcription:</strong> ${escapeHtml(cleanString(models.transcriptionModel, "n/a"))}</li>
              </ul>
            </article>
            ${apps.map((appRow) => renderApp(appRow)).join("")}
            <div class="how-note">
              This page is generated from <code>/api/how-it-works</code> so prompt text and response maps stay aligned with current server code.
            </div>
          `;
        } catch (error) {
          mount.innerHTML = `
            <article class="card">
              <h2 class="section-title">Could not load flow map</h2>
              <p class="inline-hint">${escapeHtml(cleanString(error && error.message, "API request failed."))}</p>
              <p class="inline-hint">Start the API server and ensure <code>/api/how-it-works</code> is reachable.</p>
            </article>
          `;
        }
      }

      void loadMap();
    })();
  </script>
</body>
</html>
